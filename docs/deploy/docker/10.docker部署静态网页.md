## docker å‘½ä»¤äº†è§£

```sh
# 0.æŸ¥çœ‹ images
docker images

# 1.æ ¹æ®å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ‰“åŒ…
docker build -t my-vuejs-app .

# 2.å†æ¬¡æŸ¥çœ‹ images
docker images

# 3.æŸ¥çœ‹è¿è¡Œæ‰€æœ‰çš„å®¹å™¨
docker ps

# 4.è¿è¡Œ
docker run --name my-vuejs-app -p 80:80 443:443 -d my-vuejs-app

# 5.å†æ¬¡æŸ¥çœ‹è¿è¡Œæ‰€æœ‰çš„å®¹å™¨
docker ps

# 6.åœæ­¢å®¹å™¨
docker container stop my-vuejs-app

# 7.æŸ¥çœ‹æ‰€æœ‰å®¹å™¨(åŒ…æ‹¬å·²åœæ­¢çš„)
docker ps -a

# 8.åˆ é™¤å®¹å™¨
docker constainer rm  my-vuejs-app

# 9.å†æ¬¡æŸ¥çœ‹æ‰€æœ‰å®¹å™¨(åŒ…æ‹¬å·²åœæ­¢çš„)
docker ps -a

# 10.åˆ é™¤é•œåƒ
docker container rmi my-vuejs-app:latest

# 11.å†æ¬¡æŸ¥çœ‹æ‰€æœ‰é•œåƒ
docker images
```

## éƒ¨ç½²æ‰“åŒ…å¥½çš„é™æ€æ–‡ä»¶

å¦‚æžœæ˜¯æ‰‹åŠ¨éƒ¨ç½², æŽ¨èè¿™ç§æ–¹å¼

è¿™é‡Œä»¥ vite æž„å»ºå·¥å…·åˆ›å»ºçš„é¡¹ç›®ä¸ºä¾‹, åŒ…æ‹¬ä½†ä¸é™äºŽ `vue.js/react.js` é¡¹ç›®

- ä½¿ç”¨é»˜è®¤çš„ nginx é…ç½®æ–‡ä»¶

::: code-group

```txt [æ‰“åŒ…åŽçš„ç›®å½•ç»“æž„]
.
â”œâ”€â”€ Dockerfile    # Dockerfile
â”œâ”€â”€ README.md     # é¡¹ç›®è¯´æ˜Žæ–‡ä»¶
â”œâ”€â”€ dist          # é¡¹ç›®æ‰“åŒ…åŽçš„é™æ€æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ assets
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index-653XRtVo.css
â”‚Â Â  â”‚Â Â  â””â”€â”€ index-C0gxKVtj.js
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â””â”€â”€ vite.svg
â””â”€â”€ docker-compose.yaml
```

```sh [æ‰“åŒ…é¡¹ç›®ç”¨çš„ shell è„šæœ¬]
#!/bin/bash
if [[ -d "./build" ]]; then
  rm -rf "./build"
fi

if [[ -f "./build.zip" ]]; then
  rm -rf "./build.zip"
fi

mkdir "./build"

npm run build

mv dist ./build/

cp Dockerfile docker-compose.yaml README.md ./build

zip ./build.zip -r ./build
```

```Dockerfile [Dockerfile]
FROM nginx:stable

WORKDIR /app
COPY . /app

RUN rm -rf /usr/share/nginx/html/index.html
RUN mv /app/dist/* /usr/share/nginx/html/

# nginx will use default config file: /etc/nginx/conf.d/default.conf

RUN echo "deploy completed"
```

```yaml [docker-compose.yaml]
services:
  app:
    build:
      context: "."
    container_name: app
    ports:
      - 8080:80
    restart: always
```

```sh [æ‰“åŒ…æµç¨‹ç¤ºä¾‹]
# 1. è¿›å…¥é¡¹ç›®ç›®å½•, æŽˆäºˆ build.sh æ‰§è¡Œæƒé™
chmod +x ./build.sh

# 2. æ‰§è¡Œæ‰“åŒ…è„šæœ¬
./build.sh

# 3. å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£åŽ‹,å¹¶è¿›å…¥ build ç›®å½•

# 4. ç”¨dockeréƒ¨ç½²
docker compose up -d
```

:::

## ä½¿ç”¨å®¹å™¨æ‰“åŒ…å¹¶éƒ¨ç½² VueJS é¡¹ç›®

è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºŽ CI/CD(å¦‚ Github Action)

- æ‰“åŒ…éƒ¨ç½²å¹¶ä¸”ä½¿ç”¨è‡ªå®šä¹‰çš„nginxé…ç½®

::: code-group

```Dockerfile [Dockerfile]
### 1. ç”¨ node:lts-alpine é•œåƒæ¥æ‰“åŒ…é¡¹ç›®æ–‡ä»¶
FROM node:lts-alpine AS build-app

# è®¾ç½®å·¥ä½œç›®å½• & å°†é¡¹ç›®æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­
WORKDIR /app
COPY . /app

# è®¾ç½® npm æº(åŠ é€Ÿ)
RUN npm config set registry https://registry.npmmirror.com/

# å®‰è£…pnpm å®‰è£…é¡¹ç›®ä¾èµ– æ‰“åŒ…(æ€•å‡ºçŽ°å¹»å½±ä¾èµ–çš„bug,æ‰€ä»¥ç”¨pnpm)
RUN npm install pnpm -g && \
  pnpm install --frozen-lockfile && \
  pnpm run build

# å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæµ‹è¯•åŸºæœ¬,æ£€æŸ¥ä»£ç çš„åŸºæœ¬é”™è¯¯
# RUN pnpm test

RUN echo "ðŸŽ‰ build completed"

### 2. ç”¨ nginx éƒ¨ç½²æ‰“åŒ…å¥½çš„æ–‡ä»¶
FROM nginx:stable AS deploy-app

# å°†éœ€è¦æ–‡ä»¶ä»Žä¸Šä¸€ä¸ªæ‰“åŒ…æ­¥éª¤çš„å®¹å™¨ä¸­å¤åˆ¶åˆ°æœ¬å®¹å™¨
# dist       : é¡¹ç›®æ‰“åŒ…åŽçš„æ–‡ä»¶
# nginx.conf : nginx é…ç½®æ–‡ä»¶(æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹)
# ssl_keys   : é…ç½® https éœ€è¦çš„è¯ä¹¦æ–‡ä»¶
COPY --from=build-app /app/dist       /usr/share/nginx/html/dist
COPY --from=build-app /app/nginx.conf /etc/nginx/nginx.conf

RUN echo "ðŸŽ‰ deploy completed"
```

```nginx [nginx.conf]
user  nginx;
worker_processes auto;

#error_log  /var/log/nginx/error.log;
#pid        /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log off;

    server {
        # set server name and listen port
        listen 80 default_server;
        server_name www.example.cn;

        # web root directory
        root /usr/share/nginx/html/dist;
        index index.html;

        # for vue-router history mode
        location / {
          try_files $uri $uri/ /index.html;
        }
    }
}
```

:::

## æ‰“åŒ… express é¡¹ç›®

[Github åœ¨çº¿ä»£ç ](https://github.com/liaohui5/express-mock-server)

::: code-group

```txt [ç›®å½•ç»“æž„]
.
â”œâ”€â”€ Dockerfile          # docker æž„å»ºé•œåƒçš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yaml # docker-compose é…ç½®æ–‡ä»¶
â”œâ”€â”€ .dockeringore       # docker æž„å»ºé•œåƒæ—¶éœ€è¦å¿½ç•¥çš„æ–‡ä»¶
â”œâ”€â”€ README.md           # é¡¹ç›®è¯´æ˜Žæ–‡ä»¶
â”œâ”€â”€ biome.json          # biome é…ç½®æ–‡ä»¶
â”œâ”€â”€ package.json        # package.json
â”œâ”€â”€ pm2.config.cjs      # pm2 é…ç½®æ–‡ä»¶
â”œâ”€â”€ pnpm-lock.yaml      # pnpm é”å®šä¾èµ–æ–‡ä»¶
â””â”€â”€ server.js           # é¡¹ç›®å…¥å£

1 directory, 8 files
```

```Dockerfile [Dockerfile]
# é•œåƒ: https://hub.docker.com/_/node
FROM node:lts-alpine

# è®¾ç½®çŽ¯å¢ƒå˜é‡, å¯ä»¥ç”¨ docker-compose é…ç½®æ–‡ä»¶çš„ environment è¦†ç›–
# ARG: æž„å»ºé•œåƒæ—¶ä¼ é€’çš„å‚æ•°,ä¸ä¼šä¿å­˜åˆ°é•œåƒä¸­(é»˜è®¤å‚æ•°)
# ENV: å¯åŠ¨å®¹å™¨æ—¶ä¼ é€’çš„å‚æ•°,ä¼šä¿å­˜åˆ°é•œåƒä¸­
ARG NODE_ENV=production
ENV NODE_ENV=${NODE_ENV}

# æž„å»ºé•œåƒçš„å·¥ä½œç›®å½•(/app æ˜¯å®¹å™¨ä¸­çš„è·¯å¾„)
# åœ¨ docker-compose ä¸­æ˜ å°„ public ç›®å½•ä¼šç”¨åˆ°
WORKDIR /usr/local/app

# å°†å½“å‰å®¿ä¸»æœºç›®å½•å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„å·¥ä½œç›®å½•
COPY . .

# ä½¿ç”¨æ·˜å®é•œåƒæº & å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com/ && \
    npm install -g pnpm && \
    pnpm install

# æš´éœ²ç«¯å£(æ³¨æ„è¦å’Œä»£ç ä¸­çš„ç«¯å£ä¸€è‡´)
EXPOSE 3000

# æ‰§è¡Œå¯åŠ¨å‘½ä»¤, éœ€è¦åœ¨ package.json ä¸­é…ç½®
CMD ["npm", "run", "start"]
```

```yaml [docker-compose.yaml]
---
services:
  express-mock-server:
    build:
      context: .
      tags:
        - express-mock-server
    ports:
      - 8000:8000
    environment:
      # çŽ¯å¢ƒå˜é‡æŽ§åˆ¶
      - NODE_ENV=production
      - APP_HOST=http://localhost:8000
```

```txt [.dockeringore]
node_modules
npm-debug.log
pnpm-debug.log
.git
.gitignore
.env
```

```json [package.json]
{
  "name": "express-mock-server",
  "version": "0.0.1",
  "main": "./server.js",
  "type": "module",
  "scripts": {
    "dev": "pm2 start ./server.js --watch --name mock-server",
    "start": "pm2-runtime start ./pm2.config.cjs --env production",
    "stop": "pm2 stop ./pm2.config.cjs"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^5.1.0",
    "mockjs": "^1.1.0",
    "pm2": "^6.0.8"
  }
}
```

```js [pm2.config.cjs]
// prettier-ignore
module.exports = {
  apps: [
    {
      name: "express-mock-server", // å¯åŠ¨æ—¶çš„åç§°
      script: "./server.js",       // æ‰§è¡Œçš„è„šæœ¬
      cwd: ".",                    // æ‰§è¡Œçš„å·¥ä½œç›®å½•
      watch: false,                // æ˜¯å¦ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶é‡å¯
      instances: 1,                // éœ€è¦å¯åŠ¨å¤šå°‘ä¸ªå®žä¾‹(å¤šè¿›ç¨‹è´Ÿè½½å‡è¡¡)
      autorestart: true,           // è‡ªåŠ¨é‡å¯(å¦‚æžœæ„å¤–é€€å‡º)
      max_memory_restart: "500M",  // å¦‚æžœå†…å­˜å ç”¨è¶…è¿‡ 500M åˆ™é‡å¯
      env: {                       // è‡ªåŠ¨è®¾ç½®çŽ¯å¢ƒå˜é‡, ä¸å†éœ€è¦ cross-env æ‰‹åŠ¨è®¾ç½®
        NODE_ENV: "production",
        TZ: "Asia/Shanghai",       // è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·, å¦åˆ™é»˜è®¤æ˜¯ç¾Žå›½æ—¶é—´, ä¼šå½±å“ Date API
        APP_PORT: 8000,
      },
    },
  ],
};
```

```js [server.js]
import cors from "cors";
import express from "express";
import Mock from "mockjs";

const { mock } = Mock;

/////////////////////////////////////////////////
//                 init app                    //
/////////////////////////////////////////////////
const app = express();
const config = Object.freeze({
  port: process.env.APP_PORT || 3000,
  enableCors: true,
  prefix: "/api",
  success(res, data = null) {
    res.json({
      success: true,
      msg: "success",
      data,
    });
  },
  error(res, data = null) {
    res.json({
      success: false,
      msg: "error",
      data,
    });
  },
});

// parse request body
app.use(express.json({ extended: true }));

// enable cors requests
if (config.enableCors) {
  app.use(cors());
}

/////////////////////////////////////////////////
//                  routes                     //
/////////////////////////////////////////////////
const { success, error } = config;
app.get("/", (_, res) => success(res, "OK"));
app.get("/articles", (_, res) => {
  const articles = mock({
    page: 1,
    size: 10,
    "rows|10": [
      {
        id: "@id",
        title: "@ctitle",
        contents: "@cparagraph",
      },
    ],
  });

  success(res, articles);
});

// for post example
app.post("/login", (_, res) => {
  success(res, {
    token: "mock-token-string",
  });
});

// for patch/put example
app.patch("/article/:id", (req, res) => {
  success(res, {
    id: req.params.id,
  });
});

// for delete example
app.delete("/article/:id", (req, res) => {
  success(res, {
    id: req.params.id,
  });
});

// get env variables for test pm2 config
app.get("/env", (_, res) => {
  success(res, {
    app_port: process.env.APP_PORT,
    node_env: process.env.NODE_ENV,
    timezone: process.env.TZ,
    env: process.env,
  });
});

// global error handler
app.use((err, _req, res, _next) => {
  console.error("ðŸ¤¡[ ERROR ]:", err);
  return error(res, {
    message: err.message || "Internal Server Error",
    stack: process.env.NODE_ENV === "development" ? err.stack : undefined,
  });
});

/////////////////////////////////////////////////
//                  listen                     //
/////////////////////////////////////////////////
app.listen(config.port, () => {
  const url = `http://localhost:${config.port}`;
  console.log(`server started on: ${url}`);
});
```

:::
