## docker å‘½ä»¤äº†è§£

```sh
# 0.æŸ¥çœ‹ images
docker images

# 1.æ ¹æ®å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ‰“åŒ…
docker build -t my-vuejs-app .

# 2.å†æ¬¡æŸ¥çœ‹ images
docker images

# 3.æŸ¥çœ‹è¿è¡Œæ‰€æœ‰çš„å®¹å™¨
docker ps

# 4.è¿è¡Œ
docker run --name my-vuejs-app -p 80:80 443:443 -d my-vuejs-app

# 5.å†æ¬¡æŸ¥çœ‹è¿è¡Œæ‰€æœ‰çš„å®¹å™¨
docker ps

# 6.åœæ­¢å®¹å™¨
docker container stop my-vuejs-app

# 7.æŸ¥çœ‹æ‰€æœ‰å®¹å™¨(åŒ…æ‹¬å·²åœæ­¢çš„)
docker ps -a

# 8.åˆ é™¤å®¹å™¨
docker constainer rm  my-vuejs-app

# 9.å†æ¬¡æŸ¥çœ‹æ‰€æœ‰å®¹å™¨(åŒ…æ‹¬å·²åœæ­¢çš„)
docker ps -a

# 10.åˆ é™¤é•œåƒ
docker container rmi my-vuejs-app:latest

# 11.å†æ¬¡æŸ¥çœ‹æ‰€æœ‰é•œåƒ
docker images
```

## éƒ¨ç½²æ‰“åŒ…å¥½çš„é™æ€æ–‡ä»¶

å¦‚æžœæ˜¯æ‰‹åŠ¨éƒ¨ç½², æŽ¨èè¿™ç§æ–¹å¼

è¿™é‡Œä»¥ vite æž„å»ºå·¥å…·åˆ›å»ºçš„é¡¹ç›®ä¸ºä¾‹, åŒ…æ‹¬ä½†ä¸é™äºŽ `vue.js/react.js` é¡¹ç›®

- ä½¿ç”¨é»˜è®¤çš„ nginx é…ç½®æ–‡ä»¶

::: code-group

```txt [æ‰“åŒ…åŽçš„ç›®å½•ç»“æž„]
.
â”œâ”€â”€ Dockerfile    # Dockerfile
â”œâ”€â”€ README.md     # é¡¹ç›®è¯´æ˜Žæ–‡ä»¶
â”œâ”€â”€ dist          # é¡¹ç›®æ‰“åŒ…åŽçš„é™æ€æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ assets
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index-653XRtVo.css
â”‚Â Â  â”‚Â Â  â””â”€â”€ index-C0gxKVtj.js
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â””â”€â”€ vite.svg
â””â”€â”€ docker-compose.yaml
```

```sh [æ‰“åŒ…é¡¹ç›®ç”¨çš„ shell è„šæœ¬]
#!/bin/bash
if [[ -d "./build" ]]; then
  rm -rf "./build"
fi

if [[ -f "./build.zip" ]]; then
  rm -rf "./build.zip"
fi

mkdir "./build"

npm run build

mv dist ./build/

cp Dockerfile docker-compose.yaml README.md ./build

zip ./build.zip -r ./build
```

```Dockerfile [Dockerfile]
FROM nginx:stable

WORKDIR /app
COPY . /app

RUN rm -rf /usr/share/nginx/html/index.html
RUN mv /app/dist/* /usr/share/nginx/html/

# nginx will use default config file: /etc/nginx/conf.d/default.conf

RUN echo "deploy completed"
```

```yaml [docker-compose.yaml]
services:
  app:
    build:
      context: "."
    container_name: app
    ports:
      - 8080:80
    restart: always
```

```sh [æ‰“åŒ…æµç¨‹ç¤ºä¾‹]
# 1. è¿›å…¥é¡¹ç›®ç›®å½•, æŽˆäºˆ build.sh æ‰§è¡Œæƒé™
chmod +x ./build.sh

# 2. æ‰§è¡Œæ‰“åŒ…è„šæœ¬
./build.sh

# 3. å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£åŽ‹,å¹¶è¿›å…¥ build ç›®å½•

# 4. ç”¨dockeréƒ¨ç½²
docker compose up -d
```

:::

## ä½¿ç”¨å®¹å™¨æ‰“åŒ…å¹¶éƒ¨ç½² VueJS é¡¹ç›®

è¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºŽ CI/CD(å¦‚ Github Action)

- æ‰“åŒ…éƒ¨ç½²å¹¶ä¸”ä½¿ç”¨è‡ªå®šä¹‰çš„nginxé…ç½®

::: code-group

```Dockerfile [Dockerfile]
### 1. ç”¨ node:lts-alpine é•œåƒæ¥æ‰“åŒ…é¡¹ç›®æ–‡ä»¶
FROM node:lts-alpine AS build-app

# è®¾ç½®å·¥ä½œç›®å½• & å°†é¡¹ç›®æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­
WORKDIR /app
COPY . /app

# è®¾ç½® npm æº(åŠ é€Ÿ)
RUN npm config set registry https://registry.npm.taobao.org

# å®‰è£…pnpm å®‰è£…é¡¹ç›®ä¾èµ– æ‰“åŒ…(æ€•å‡ºçŽ°å¹»å½±ä¾èµ–çš„bug,æ‰€ä»¥ç”¨pnpm)
RUN npm install pnpm -g && \
  pnpm install --frozen-lockfile && \
  pnpm run build

# å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œæµ‹è¯•åŸºæœ¬,æ£€æŸ¥ä»£ç çš„åŸºæœ¬é”™è¯¯
# RUN pnpm test

RUN echo "ðŸŽ‰ build completed"

### 2. ç”¨ nginx éƒ¨ç½²æ‰“åŒ…å¥½çš„æ–‡ä»¶
FROM nginx:stable AS deploy-app

# å°†éœ€è¦æ–‡ä»¶ä»Žä¸Šä¸€ä¸ªæ‰“åŒ…æ­¥éª¤çš„å®¹å™¨ä¸­å¤åˆ¶åˆ°æœ¬å®¹å™¨
# dist       : é¡¹ç›®æ‰“åŒ…åŽçš„æ–‡ä»¶
# nginx.conf : nginx é…ç½®æ–‡ä»¶(æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹)
# ssl_keys   : é…ç½® https éœ€è¦çš„è¯ä¹¦æ–‡ä»¶
COPY --from=build-app /app/dist       /usr/share/nginx/html/dist
COPY --from=build-app /app/nginx.conf /etc/nginx/nginx.conf

RUN echo "ðŸŽ‰ deploy completed"
```

```nginx [nginx.conf]
user  nginx;
worker_processes auto;

#error_log  /var/log/nginx/error.log;
#pid        /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log off;

    server {
        # set server name and listen port
        listen 80 default_server;
        server_name www.example.cn;

        # web root directory
        root /usr/share/nginx/html/dist;
        index index.html;

        # for vue-router history mode
        location / {
          try_files $uri $uri/ /index.html;
        }
    }
}
```

:::

## æ‰“åŒ… express é¡¹ç›®

ä»… express ä»£ç , ä¸åŒ…å«é“¾æŽ¥æ•°æ®åº“é…ç½®

::: code-group

```txt [ç›®å½•ç»“æž„]
.
â”œâ”€â”€ Dockerfile            # æž„å»ºé•œåƒé…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md
â”œâ”€â”€ app.js                # æœåŠ¡ç«¯ä»£ç 
â”œâ”€â”€ docker-compose.yaml   # docker-compose é…ç½®æ–‡ä»¶
â”œâ”€â”€ package-lock.json     # ä¾èµ–ç®¡ç†æ–‡ä»¶
â”œâ”€â”€ package.json          # é¡¹ç›®é…ç½®æ–‡ä»¶
â””â”€â”€ public                # é™æ€æ–‡ä»¶ç›®å½•
    â””â”€â”€ upload
        â””â”€â”€ 40a080a7-afe3-4e43-a4bf-f29f1ced2f1a.png

3 directories, 7 files
```

```Dockerfile [Dockerfile]
# é•œåƒ: https://hub.docker.com/_/node
FROM node:lts-alpine

# è®¾ç½®çŽ¯å¢ƒå˜é‡, å¯ä»¥ç”¨ docker-compose é…ç½®æ–‡ä»¶çš„ environment è¦†ç›–
# ARG: æž„å»ºé•œåƒæ—¶ä¼ é€’çš„å‚æ•°,ä¸ä¼šä¿å­˜åˆ°é•œåƒä¸­(é»˜è®¤å‚æ•°)
# ENV: å¯åŠ¨å®¹å™¨æ—¶ä¼ é€’çš„å‚æ•°,ä¼šä¿å­˜åˆ°é•œåƒä¸­
ARG NODE_ENV=production
ENV NODE_ENV=${NODE_ENV}
ARG APP_HOST=http://localhost:3000
ENV APP_HOST=${APP_HOST}

# æž„å»ºé•œåƒçš„å·¥ä½œç›®å½•(/app æ˜¯å®¹å™¨ä¸­çš„è·¯å¾„)
# åœ¨ docker-compose ä¸­æ˜ å°„ public ç›®å½•ä¼šç”¨åˆ°
WORKDIR /app

# å°†å½“å‰å®¿ä¸»æœºç›®å½•å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„å·¥ä½œç›®å½•
COPY . .

# ä½¿ç”¨è…¾è®¯ npm é•œåƒæº & å®‰è£…ä¾èµ–
RUN npm config set registry https://mirrors.tencent.com/npm/
RUN npm install

# æš´éœ²ç«¯å£(æ³¨æ„è¦å’Œä»£ç ä¸­çš„ç«¯å£ä¸€è‡´)
EXPOSE 3000

# æ‰§è¡Œå¯åŠ¨å‘½ä»¤, éœ€è¦åœ¨ package.json ä¸­é…ç½®
CMD ["npm", "run", "start"]
```

```yaml [docker-compose.yaml]
services:
  app:
    image: express-api-demo # dockeræ‰“åŒ…åŽçš„é•œåƒåç§°
    build: .
    volumes:
      # æ˜ å°„å®¹å™¨ä¸­çš„ç›®å½•(æ³¨æ„å½“å‰ç›®å½•ä¸‹çš„ public ç›®å½•å¿…é¡»å­˜åœ¨, å¦åˆ™å¯èƒ½æŠ¥é”™)
      - ./public:/app/public
    ports:
      # ç«¯å£æ˜ å°„(å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£)
      - 8000:3000
    environment:
      # çŽ¯å¢ƒå˜é‡æŽ§åˆ¶
      - NODE_ENV=production
      - APP_HOST=http://localhost:8000
```

```js [dist/app.js]
import express from "express";
import cors from "cors";
import multer from "multer";
import path from "node:path";
import fs from "node:fs";
import { v4 as uuidv4 } from "uuid";

// setup express app
const app = express();
const port = 3000;
const host = process.env.APP_HOST || `http://localhost:${port}`;
const publicDir = "public";
const uploadDir = "upload";
app.set("app_host", host);
app.set("publicDir", publicDir);
app.set("uploadDir", uploadDir);
app.set("uploadPath", path.join(publicDir, uploadDir));

// middlewares
app.use(cors());
app.use(express.json());
app.use(express.static(publicDir));

// helper functions
function mkdirIfNotExists(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
}

// format response body struct
app.use((_req, res, next) => {
  res.success = function (results = null, message = "success") {
    return res.json({
      success: true,
      results,
      message,
    });
  };

  res.failed = function (results = null, message = "failed") {
    return res.json({
      success: false,
      results,
      message,
    });
  };

  return next();
});

///////////////////////////////////////////////////
// check health api
///////////////////////////////////////////////////
app.get("/", (_req, res) => res.success());

///////////////////////////////////////////////////
// upload file api
///////////////////////////////////////////////////
const storage = multer.diskStorage({
  filename(_req, file, callback) {
    const filename = uuidv4();
    const extname = path.extname(file.originalname);
    callback(null, `${filename}${extname}`);
  },
  destination(req, _file, callback) {
    const savePath = req.app.get("uploadPath");
    mkdirIfNotExists(savePath);
    callback(null, savePath);
  },
});
app.post("/upload", multer({ storage }).single("file"), (req, res) => {
  const filePath = path.join(req.app.get("uploadDir"), req.file.filename);
  const fileURL = [app.get("app_host"), "/", filePath].join("");

  res.success({
    filePath,
    fileURL,
  });
});

// global error handler
app.use((err, _req, res, _next) => res.failed(err.message));

// listen
app.listen(port, () => console.log(`>>>Server started on ${host}`));
```

```json [dist/package.json]{7}
{
  "name": "express-api-demo",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "start": "node ./app.js"
  },
  "dependencies": {
    "cors": "2.8.5",
    "express": "5.0.1",
    "multer": "1.4.5-lts.1",
    "uuid": "11.0.3"
  }
}
```

:::
