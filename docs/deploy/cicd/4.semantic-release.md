## semantic-release æ˜¯ä»€ä¹ˆ?

semantic-release æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†å’ŒåŒ…å‘å¸ƒçš„å·¥å…·, å®ƒå…è®¸å¼€å‘è€…æ ¹æ®è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
(Semantic Versioning, SemVer)è§„èŒƒæ¥è‡ªåŠ¨å‘å¸ƒè½¯ä»¶åŒ…, é€šè¿‡é›†æˆåˆ°æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²(CI/CD)ç®¡é“ä¸­
semantic-release å¯ä»¥åœ¨æ¯æ¬¡ä»£ç æäº¤æ—¶æ£€æŸ¥æ˜¯å¦æ»¡è¶³å‘å¸ƒæ–°ç‰ˆæœ¬çš„æ¡ä»¶, å¹¶ä¸”å¦‚æœæ»¡è¶³, åˆ™ä¼šè‡ªåŠ¨ç¡®å®šæ–°çš„ç‰ˆæœ¬å·ã€ç”Ÿæˆå˜æ›´æ—¥å¿—ã€å‘å¸ƒåˆ°æ³¨å†Œè¡¨æˆ–ä»“åº“

- [github](https://github.com/semantic-release/semantic-release)
- [docs](https://semantic-release.gitbook.io/semantic-release/)

## semantic-release èƒ½åšä»€ä¹ˆ?

- æ ¹æ® git æäº¤è®°å½•è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿—, ä½†æ˜¯ git æäº¤è®°å½•çš„æ ¼å¼å¿…é¡»è¦ç¬¦åˆ[æäº¤è§„èŒƒ, æ¨èé˜…è¯»](https://www.conventionalcommits.org/zh-hans/v1.0.0/)
- è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·
- è‡ªåŠ¨ä¸Šä¼  assets åˆ° GitHub Releases
- è‡ªåŠ¨å‘å¸ƒè½¯ä»¶åŒ…åˆ° [npm](https://www.npmjs.com/) æˆ–è€… [verdaccio](https://verdaccio.org/zh-cn/)
- ç¤¾åŒºå¼ºå¤§, ä¹Ÿå¯ä»¥å‘å¸ƒå…¶ä»–è¯­è¨€ package manager çš„è½¯ä»¶åŒ…åˆ°å®ƒå¯¹åº”çš„ç½‘ç«™, æ¯”å¦‚:

  - python: [pypi](https://github.com/abichinger/semantic-release-pypi)
  - php: [composer](https://github.com/ambimax/semantic-release-composer)
  - java: [maven](https://github.com/akijoey/semantic-release-maven) æˆ– [gradle](https://github.com/KengoTODA/gradle-semantic-release-plugin)
  - rust: [cargo](https://github.com/buehler/semantic-release-cargo)
  - [æ›´å¤šæ’ä»¶, è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£](https://semantic-release.gitbook.io/semantic-release/extending/plugins-list)

## 1.å‡†å¤‡é¡¹ç›®

::: code-group

```sh [ç¬¬ä¸€æ­¥]
# 1. åˆ›å»ºä¸€ä¸ªç©ºçš„ npm é¡¹ç›®
mkdir semantic-release-demo
cd semantic-release-demo
pnpm init
```

```sh [ç¬¬äºŒæ­¥]
# 2. å®‰è£… typescript å’Œ semantic-release åŠéœ€è¦çš„æ’ä»¶
pnpm i -D semantic-release
pnpm i -D @semantic-release/changelog
pnpm i -D @semantic-release/git

# å®‰è£… typescript, å› ä¸ºç°åœ¨å¤§å¤šé¡¹ç›®éƒ½éœ€è¦ç¼–è¯‘, ä¸ºäº†è¿˜åŸçœŸå®
# çš„å¼€å‘ç¯å¢ƒ, ä¸”å°½é‡å‡å°‘é…ç½®, è¿™é‡Œä½¿ç”¨ typescript ç¼–è¯‘
pnpm i -D typescript
```

```jsonc {4-14} [ç¬¬ä¸‰æ­¥]
// 3. ä¿®æ”¹ package.json(jsonæ–‡ä»¶ä¸èƒ½æœ‰æ³¨é‡Š, æˆ‘è¿™é‡Œæ·»åŠ äº†æ³¨é‡Šæ˜¯ä¸ºäº†åšç¬”è®°)
{
  "name": "semantic-release-demo-a1b2c3", // æ³¨æ„åŒ…åå¿…é¡»æ˜¯å”¯ä¸€çš„,ä¸èƒ½æœ‰é‡å¤çš„
  "version": "0.0.1",
  "main": "dist/index.js",
  "type": "module",
  "scripts": {
    "build": "tsc",
    "release": "semantic-release --debug"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/liaohui5/for-write-note-demo.git" // å¡«å†™è‡ªå·±çš„ä»“åº“åœ°å€
  },
  "keywords": [],
  "author": "",
  "license": "MIT",
  "description": "",
  "devDependencies": {
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "semantic-release": "^24.2.1",
    "typescript": "^5.7.3"
  }
}
```

```jsonc [ç¬¬å››æ­¥]
// 4. æ’ä»¶ tsconfig.json é…ç½®æ–‡ä»¶
{
  "include": ["./src/**/*.ts"],
  "compilerOptions": {
    "target": "es2016",
    "module": "ES2015",
    "rootDirs": ["."],
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "./dist",
    "strict": true,
    "skipLibCheck": true
  }
}
```

```js [ç¬¬äº”æ­¥]
// åˆ›å»º src/index.ts, ä»£ç æ— æ‰€è°“, ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯• ci/cd
export function for_test_release_ci_cd_func() {
  console.log("1");
}
```

```sh [ç¬¬å…­æ­¥]
# ç¼–è¯‘å¹¶æµ‹è¯•
npm run build
```

```sh [ç¬¬ä¸ƒæ­¥]
# å¦‚æœå‰é¢éƒ½æ²¡æœ‰é—®é¢˜, ç›®å½•åº”è¯¥æ˜¯è¿™æ ·çš„
.
â”œâ”€â”€ dist               # ç¼–è¯‘åçš„æ–‡ä»¶
â”‚Â Â  â””â”€â”€ index.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ index.ts       # æºæ–‡ä»¶
â””â”€â”€ tsconfig.json
```

:::

## 2.å‡†å¤‡ GitHub ä»“åº“

åšè¿™äº›æ­¥éª¤ä¹‹å‰, è¯·å…ˆè‡ªè¡Œæ³¨å†Œå¹¶ç™»å½• github è´¦å·

> [!TIP] 1.è·å– Github Token ç”¨äº Github Actions

[è·å– GitHub Token ä¼ é€é—¨](https://github.com/settings/tokens)

![get-github-token1](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131434487.png)
![get-github-token2](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131426380.png)
![get-github-token3](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131427346.png)

> [!TIP] 2.åˆ›å»ºä¸€ä¸ªç©ºçš„ GitHub ä»“åº“, å¹¶é…ç½® GitHub Actions Secrets

![set-secrets1](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131438082.png)
![set-secrets2](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131440500.png)

## 3.å‡†å¤‡ npmjs.com çš„è´¦å·çš„ token

è¯·å…ˆè‡ªè¡Œæ³¨å†Œå¹¶ç™»å½• npmjs.com

> [!TIP] 1.è·å– npmjs.com Token ç”¨äº Github Actions

![1](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131445023.png)
![2](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131447795.png)
![3](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131448238.png)

> [!TIP] 2.å°†è·å–åˆ°çš„ npmjs.com Token é…ç½®åˆ° GitHub Actions Secrets

![4](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131451886.png)

## 4.é…ç½® semantic-release

åœ¨é¡¹ç›®ç›®å½•ä¸­åˆ›å»º `release.config.js` æ–‡ä»¶, å†…å®¹å¦‚ä¸‹:

ä»£ç æ²¡æœ‰å¤šå°‘, ä¸»è¦éƒ½æ˜¯æ³¨é‡Š...ğŸ˜„ğŸ˜„ğŸ˜„

```js
/**
 * @type {import('semantic-release').GlobalConfig}
 */
export default {
  branches: ["main", "next"], // å“ªäº› git åˆ†æ”¯éœ€è¦è§¦å‘ semantic-release
  plugins: [
    // 1.å®‰è£…(pnpm i -D semantic-release) å, é»˜è®¤ä¼šæœ‰è¿™4ä¸ªæ’ä»¶
    // commit-analyzer/release-notes-generator/npm/github
    [
      // åˆ†ææäº¤è®°å½•çš„ conventional-changelog, ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
      // https://github.com/semantic-release/commit-analyzer
      "@semantic-release/commit-analyzer",
      {
        // ä¼šæ ¹æ®æäº¤è®°å½•çš„  åˆ†æå‡ºä¿®æ”¹çš„ç‰ˆæœ¬
        // ç”¨äºæ§åˆ¶ä¿®æ”¹ç‰ˆæœ¬è§„åˆ™ major.minor.patch
        // æ¨èé˜…è¯»: https://www.conventionalcommits.org/zh-hans/v1.0.0/
        // å¦‚æœéœ€è¦ä¿®æ”¹ major ç‰ˆæœ¬, åªéœ€è¦åœ¨ commit ç±»å‹åæ·»åŠ  ! å³å¯, å¦‚: feat!: xxx
        // å¹¶ä¸”åœ¨ git æäº¤æ¶ˆæ¯ä½“ä¸­å¢åŠ : BREAKING CHANGE: xxx, å¦‚:
        // feat!: å¢åŠ äº†xxxåŠŸèƒ½,ä¼˜åŒ–äº†xxxæ€§èƒ½
        //                                 (æ³¨æ„æŒ‰ç…§è§„èŒƒ, è¿™é‡Œå¿…é¡»æœ‰ä¸ªç©ºè¡Œ)
        // BREAKING CHANGE: xxx
        releaseRules: [
          { type: "fix", release: "patch" }, // å¦‚æœ push ä»£ç æ—¶æœ‰ fix ç±»å‹çš„æäº¤ä¿¡æ¯, åˆ™ä¿®æ”¹ç‰ˆæœ¬å·ä¸º patch
          { type: "refactor", release: "patch" },
          { type: "perf", release: "patch" },
          { type: "chore", release: "patch" },
          { type: "feat", release: "minor" }, // å¦‚æœ push ä»£ç æ—¶æœ‰ feat ç±»å‹çš„æäº¤ä¿¡æ¯, åˆ™ä¿®æ”¹ç‰ˆæœ¬å·ä¸º minor
        ],
      },
    ],

    // 2.å¦‚æœéœ€è¦ç»™æ’ä»¶ä¼ å…¥å‚æ•°, å¯ä»¥ä½¿ç”¨æ•°ç»„å½¢å¼, æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ’ä»¶åç§°,
    // åé¢æ˜¯æ’ä»¶å‚æ•°, ä¸éœ€è¦ä¼ å‚å¯ä»¥ç”¨å­—ç¬¦ä¸²çš„å½¢å¼
    // è¿™ä¸ªæ’ä»¶çš„åŠŸèƒ½æ˜¯: ä½¿ç”¨ conventional-changelog ç”Ÿæˆå˜æ›´æ—¥å¿—å†…å®¹
    // https://github.com/semantic-release/npm
    // https://github.com/semantic-release/release-notes-generator
    "@semantic-release/release-notes-generator",

    // 3.æ¯ä¸ªå‘å¸ƒæ­¥éª¤éƒ½æ˜¯é€šè¿‡å¯é…ç½®çš„æ’ä»¶å®ç°çš„, ä¸ºäº†å®ç°æ›´æ–¹ä¾¿çš„åŠŸèƒ½, å¯ä»¥å»å®˜ç½‘æ‰¾æ›´å¤šéœ€è¦çš„æ’ä»¶:
    // https://semantic-release.gitbook.io/semantic-release/extending/plugins-list
    [
      // å°† Github Actions ç”Ÿæˆçš„æäº¤è®°å½•, å†™å…¥åˆ° CHANGELOG.md æ–‡ä»¶ä¸­
      "@semantic-release/changelog",
      {
        changelogFile: "CHANGELOG.md",
      },
    ],

    // 3. å°†ä»£ç å‘å¸ƒåˆ° npmjs.com ä»“åº“
    // https://github.com/semantic-release/npm
    [
      "@semantic-release/npm",
      {
        // npmPublish: æ˜¯å¦å‘å¸ƒåˆ° npm ä»“åº“, false: è¡¨ç¤ºä¸å‘å¸ƒ true:è¡¨ç¤ºå‘å¸ƒåˆ° npm ä»“åº“
        // 1.æ³¨æ„éœ€è¦é…ç½® github secrets
        // 2.ä¼šè‡ªåŠ¨ä¿®æ”¹ package.json çš„ version å­—æ®µ
        // 3.å¦‚æœå¼€å¯äº† 2fa å®‰å…¨éªŒè¯ç , éœ€è¦åœ¨ç”Ÿæˆ npm token æ—¶é€‰æ‹© "Automation" ç±»å‹
        npmPublish: true,
      },
    ],

    // 4. é»˜è®¤æƒ…å†µä¸‹ semantic-release æ‰“åŒ…å‘å¸ƒçš„ç‰ˆæœ¬ä¸ commit çš„ç‰ˆæœ¬å·ä¸€è‡´, ä½†æ˜¯ä¸ package.json
    // çš„ç‰ˆæœ¬å·ä¸ä¸€è‡´, æ‰€ä»¥è¦é…ç½®è®© github tag å’Œ package.json ç‰ˆæœ¬å·ä¿æŒä¸€è‡´
    [
      "@semantic-release/git",
      {
        assets: ["dist"],
        message:
          "ci(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}",
      },
    ],

    // 5.è¿™ä¸ªæ˜¯å‘å¸ƒåˆ° tags é¡µé¢çš„é¢å¤–èµ„æº, æ¯”å¦‚ä¸€äº›è½¯ä»¶ä¼šæŠŠæ„å»ºç»“æœçš„åŒ…æ”¾åœ¨è¿™é‡Œ
    // æ¯”å¦‚: https://github.com/clash-verge-rev/clash-verge-rev/releases/tag/v2.0.2
    // é™¤äº†æºç (tar.gz)å‹ç¼©åŒ…ä¹‹å¤–, è¿˜å¢åŠ äº†å¾ˆå¤šæ„å»ºå¥½çš„è½¯ä»¶, å¦‚: Clash.Verge_2.0.2_x64-setup.exe
    // æˆ‘è¿™é‡Œå°±æŠŠè¿™ä¸ªé¡¹ç›®çš„ typescript æ„å»ºå¥½çš„ä»£ç éƒ½æ”¾åœ¨è¿™é‡Œ
    // https://github.com/semantic-release/git
    [
      "@semantic-release/github",
      {
        assets: ["dist"],
      },
    ],
  ],
};
```

## 5. é…ç½® GitHub Actions workflows

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»º `.github/workflows/release.yml` æ–‡ä»¶, å†…å®¹å¦‚ä¸‹:

```yaml
name: Release

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ç¡®ä¿æœ‰å†™å…¥æƒé™
      packages: write # å¦‚æœä½ ä¹Ÿåœ¨å‘å¸ƒåŒ…çš„è¯
      pull-requests: write # å¦‚æœéœ€è¦å¤„ç† PR ç›¸å…³çš„äº‹æƒ…
    steps:
      - name: download codes
        uses: actions/checkout@v4

      - name: install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: install node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install dependencies
        run: pnpm install

      # - name: run unit tests
      #   run: pnpm test

      - name: build
        run: pnpm build

      - name: run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }} # æ³¨æ„è¿™2ä¸ªå˜é‡,è¦å’Œgithub scretsä¸­é…ç½®çš„ä¸€è‡´
        run: pnpm run release
```

> [!TIP]
> å¦‚æœè¿™äº›æ­¥éª¤éƒ½æ²¡æœ‰é—®é¢˜, ç›®å½•ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„

```txt
.
â”œâ”€â”€ .github
â”‚Â Â  â””â”€â”€ workflows
â”‚Â Â      â””â”€â”€ release.yaml
â”œâ”€â”€ dist
â”‚Â Â  â””â”€â”€ index.js
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ release.config.js
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ index.ts
â””â”€â”€ tsconfig.json
```

## 6.æäº¤ä»£ç 

1. æ³¨æ„åˆ†æ”¯å¿…é¡»æ˜¯ `main`
2. æ³¨æ„æäº¤ä»£ç æ—¶, æäº¤ä¿¡æ¯å¿…é¡»ç¬¦åˆè§„èŒƒ(æ‰èƒ½ä¿è¯æ­£ç¡®ç”Ÿæˆ changelog)
3. æäº¤ä¹‹åæŸ¥çœ‹ github runners, ä¼šè‡ªåŠ¨å‘å¸ƒåˆ° npmjs.com ä»“åº“å’Œ github releases é¡µé¢

![preview-runner](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131531803.png)

å¯ä»¥çœ‹åˆ°æ²¡æœ‰é—®é¢˜, å·²ç»æ“ä½œæˆåŠŸäº†

![github-success](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131544170.png)
![npm-success](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131545305.png)

## 7. ä¿®æ”¹ä»£ç å†æ¬¡æäº¤æµ‹è¯•

è¿™æ¬¡ä¸è¦åœ¨ `main` åˆ†æ”¯ä¿®æ”¹ä»£ç , è€Œæ˜¯æ–°å»ºä¸€ä¸ª `next` åˆ†æ”¯, ä¿®æ”¹ä»£ç ååœ¨æäº¤æµ‹è¯•

![next-preview](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131552275.png)

æäº¤ä¹‹å, ä¼šæç¤ºæœ‰ `pull-request` éœ€è¦åˆå¹¶åˆ° `main` åˆ†æ”¯, ç‚¹å‡» `Compare & pull request` åˆå¹¶

![pull-request](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131556221.png)

åˆå¹¶è¯·æ±‚å,ä¼šè‡ªåŠ¨è§¦å‘ `release` workflow, ç„¶åé‡æ–°æ‰“ tag, ç”Ÿæˆ changelog, ä¸Šä¼  assets, å‘å¸ƒåˆ° npm

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131558070.png)

## æ‰©å±•

ä¸€èˆ¬ä¼ä¸šå†…éƒ¨éå¼€æºçš„ä»£ç ä¸ä¼šæ”¾åˆ° github å’Œ npm ä¸Šå»

### å¦‚ä½•æ­å»º npm ç§æœå¹¶ä¸”å°†åŒ…å‘å¸ƒåˆ°ç§æœ, è€Œä¸æ˜¯ npmjs.com?

1. [æ­å»º npm ç§æœ](/deploy/docker/21.éƒ¨ç½²npmç§æœ)
2. è·å– npm ç§æœçš„ token, ç™»å½•ç§æœåä¼šå­˜åœ¨ `~/.npmrc` æ–‡ä»¶ä¸­

![verdaccio token](https://raw.githubusercontent.com/liaohui5/images/main/images/202501131604334.png)

3. åœ¨ package.json ä¸­æ·»åŠ  `publishConfig` å­—æ®µ

```json
"repository": {
  "type": "git",
  "url": "git+https://github.com/liaohui5/single-utils-demo"
}
```

4. å°† github é…ç½®çš„ secrets ä¸­çš„ NPM_TOKEN ä¿®æ”¹ä¸º verdaccio ç§æœçš„ token

### å¦‚ä½•ä½¿ç”¨ gitea/gitlab å®Œæˆè¿™äº›æ“ä½œ?

1. åªè¦å®‰è£…å¯¹åº”ä»£ç æ‰˜ç®¡å‡­ä»–çš„æ’ä»¶

   - [gitea](https://github.com/saitho/semantic-release-gitea)
   - [gitlab](https://github.com/semantic-release/gitlab)

2. å°† `release.config.js` ä¸­çš„ `@semantic-release/github` ä¿®æ”¹å³å¯
3. å°† `.github/workflows/release.yml` ä¿®æ”¹ä¸ºå¯¹åº”å¹³å°çš„ cicd å·¥ä½œæµå³å¯
