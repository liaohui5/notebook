---
outline: deep
---

## ä»‹ç»

Drone CI æ˜¯ä¸€ä¸ªå¼€æºçš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²å·¥å…·ï¼Œå®ƒä½¿ç”¨ Docker å®¹å™¨æ¥è¿è¡Œæ„å»ºå’Œæµ‹è¯•ä»»åŠ¡ï¼Œå¹¶æ”¯æŒå¤šç§ä»£ç ä»“åº“

- [ä¸­æ–‡æ–‡æ¡£](https://drone.cool/)
- [è‹±æ–‡æ–‡æ¡£](https://docs.drone.io/)
- [drone-runner github](https://github.com/drone-runners)
- [drone-server github](https://github.com/drone/drone-ui)

<span class="red-text"> æ³¨: å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡å­¦ CICD, æˆ‘æ˜¯ä¸æ¨èè¿™ä¸ªçš„, è¿˜æ˜¯æ›´æ¨è jenkins / gitlab ç­‰
æ¯”è¾ƒçŸ¥åçš„å¼€æºé¡¹ç›®, å› ä¸ºè¿™äº›é¡¹ç›®åæ°”æ›´å¤§, å‘¨è¾¹ç”Ÿæ€æ›´ä¸°å¯Œ </span>

## ä¸ºä»€ä¹ˆç”¨ Drone CICD ?

> ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ›´çŸ¥åçš„ travis æˆ–è€… jenkins ?

å‘ƒ...è¿™ä¸ªå¯èƒ½æ˜¯å› ä¸ºç¬¬ä¸€å°è±¡ ğŸ˜„ğŸ˜„ğŸ˜„ ç”±äºæˆ‘æœ€å¼€å§‹æ¥è§¦ cicd å°±æ˜¯ç”¨çš„æ˜¯è¿™ä¸ª, ä¸ºäº†åé¢æ–¹ä¾¿æŸ¥é˜…, åšä¸ªç¬”è®°

> å…è´¹çš„ runner é…ç½®ä½

ä¸ç®¡æ˜¯ Github Actions è¿˜æ˜¯ GitLab CICD éƒ½æ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥è¿è¡Œæµæ°´çº¿(æˆ–è€…å«å·¥ä½œæµ)å®šä¹‰çš„é‚£äº›ä»»åŠ¡çš„, éƒ½éœ€è¦ `Runner`,
é‚£ä¹ˆè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜, å¦‚æœæ˜¯ä½¿ç”¨ gitlab.com æˆ–è€… github.com æä¾›çš„å…è´¹ runner, ä»–ä»¬çš„é…ç½®å¹¶ä¸é«˜,
å¦‚æœå¤§é¡¹ç›®ç¼–è¯‘/æµ‹è¯•/æ‰“åŒ…å°±ä¼šéå¸¸æ…¢, å¦‚æœéœ€è¦æ›´é«˜çš„é…ç½®, è¿˜æ˜¯éœ€è¦è‡ªå·±å»é…ç½®æ³¨å†Œ runner

> gitlab å’Œ github æµæ°´çº¿é…ç½®æ–‡ä»¶æ— æ³•é€šç”¨

ä½¿ç”¨ Github Actions å°±è¦å»å­¦ä¸€æ¬¡ Github Actions é…ç½®æ–‡ä»¶çš„å­—æ®µè¯­æ³•ç­‰, ç”¨ GitLab CICD åˆéœ€è¦å†å­¦ä¸€æ¬¡, è¿™å°±å¾ˆéš¾å—äº†...

æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥: åªå­¦ä¸€æ¬¡ç„¶ååœ¨å„ä¸ªå¹³å°(gitlab/github/gitea/gogs/bitbucket)éƒ½èƒ½ä½¿ç”¨çš„ æµæ°´çº¿é…ç½®æ–‡ä»¶å’Œ runner

> ç¼ºç‚¹

1. æ²¡æœ‰ä¸­æ–‡æ–‡æ¡£
2. åŠŸèƒ½æ¯”è¾ƒè½»é‡çº§(ä½†æ˜¯æ­é… gitea/gitness è¶³å¤Ÿåº”ä»˜å¤šæ•°æƒ…å†µçš„å¼€å‘ä»»åŠ¡äº†)
3. æ’ä»¶è¾ƒå°‘, ä¹Ÿä¸å…¼å®¹ github actions

è™½ç„¶å®ç°äº† "è·¨gitç®¡ç†è½¯ä»¶" ä¸”å®Œå…¨å¼€æº, ä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾, ç¤¾åŒºä¸å¤Ÿå¼ºå¤§, æ’ä»¶è¾ƒå°‘

## ç¬”è®°å¯¹åº”çš„ä»£ç 

- [https://github.com/lh5sa/learn-drone-cicd-demo](https://github.com/lh5sa/learn-drone-cicd-demo)

## plugins

å’Œ github actions ç±»ä¼¼, å®ƒä¹Ÿæœ‰ç±»ä¼¼çš„[æ’ä»¶å¸‚åœº](https://plugins.drone.io/)

## å®‰è£… gitea + Drone CI

### åˆ›å»º docker-compose.yml

<!-- prettier-ignore-start -->

```yaml
version: "3"

networks:
  gitea:
    external: false

services:
  gitea_server:
    image: gitea/gitea:1.21.2
    container_name: gitea
    hostname: giteaserver
    environment:
      USER_UID: 1000
      USER_GID: 1000
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: 'db:5432'
      GITEA__database__NAME: gitea          # æ³¨æ„è¦å’Œ db çš„ environment ä¸­å¡«çš„ä¸€æ ·
      GITEA__database__USER: admin
      GITEA__database__PASSWD: admin1314  
    restart: always
    depends_on:
      - db
    networks:
      - gitea
    volumes:
      - ./gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "8000:3000"
      - "8001:22"

  db:
    image: postgres:14
    container_name: postgres
    restart: always
    hostname: postgres_server
    environment:
      POSTGRES_DB: gitea           # æ•°æ®åº“å
      POSTGRES_USER: admin         # æ•°æ®åº“ç”¨æˆ·
      POSTGRES_PASSWORD: admin1314 # æ•°æ®åº“å¯†ç 
    networks:
      - gitea
    ports:
      - "8002:5432"
    volumes:
      - ./postgres_conf:/etc/postgresql
      - ./postgres_data:/var/lib/postgresql/data

  # for cicd
  drone:
    image: drone/drone:2
    container_name: drone
    restart: always
    hostname: droneserver
    depends_on:
      - db
    networks:
      - gitea
    ports:
      - '8003:80'
    volumes:
      - ./drone_config:/var/lib/drone
    environment:
      TZ: Asia/Shanghai
      DRONE_GITEA_SERVER: https://gitea.examples.cn                                       # gitea éƒ¨ç½²çš„åŸŸå
      DRONE_GITEA_CLIENT_ID: c4d3610e-f3bb-4224-857f-fb27c7712345                         # gitea client id
      DRONE_GITEA_CLIENT_SECRET: gto_spqtexjlzwgyqx77pyq57hmye2r5qakeq6uug6uqliocxjm12345 # gitea client secret
      DRONE_RPC_SECRET: cbce82a5d5e5772b8daf59202c612345                                  # ä¸ runner é€šä¿¡çš„ secret
      DRONE_SERVER_HOST: https://dronecicd.examples.cn                                    # drone éƒ¨ç½²çš„åŸŸå
      DRONE_SERVER_PROTO: https                                                           # æ³¨æ„åè®®
      DRONE_USER_CREATE: username:secret,admin:true                                       # è¶…çº§ç®¡ç†å‘˜è´¦å·
      DRONE_DATABASE_DRIVER: postgres                                                     # ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶å®šä¹‰çš„æœåŠ¡, è€Œä¸æ˜¯é•œåƒå†…éƒ¨çš„ pgsql
      DRONE_DATABASE_DATASOURCE: postgres://admin:admin1314@postgres_server:5432/postgres?sslmode=disable

  # cicd runner
  drone-runner:
    image: drone/drone-runner-docker:1
    restart: always
    container_name: drone-runner
    depends_on:
      - drone
    networks:
      - gitea
    ports:
      - '8004:3000'
    environment:
      DRONE_RPC_HOST: droneserver                        # æ³¨æ„éœ€è¦åœ¨åŒä¸€ network ä¸‹æ‰å¯ä»¥ä½¿ç”¨ hostname
      DRONE_RPC_PROTO: http                              # æ³¨æ„åè®®æ˜¯ http, å› ä¸ºç°åœ¨èµ°çš„æ˜¯ hostname æ‰€ä»¥ä¸æ˜¯ https
      DRONE_RPC_SECRET: cbce82a5d5e5772b8daf59202c612345 # runner ä¸ drone server é€šä¿¡çš„ secret
      DRONE_UI_USERNAME: root
      DRONE_UI_PASSWORD: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
```

<!-- prettier-ignore-end -->

```sh
# å¯åŠ¨
docker compose up -d
```

### æ³¨å†Œ gitea oauth app

`ç‚¹å‡»å¤´åƒ -> è®¾ç½® -> åº”ç”¨`

æ³¨æ„åœ°å€ä¸è¦å¡«é”™, è¦å¡«å†™çœŸå®çš„åœ°å€, è·å– `client_id` å’Œ `client_secret`

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151229059.png)

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151233473.png)

### ä¿®æ”¹ docker-compose.yml

1. ä¿®æ”¹ oauth ç™»å½•ä¿¡æ¯

- DRONE_GITEA_CLIENT_ID: your_client_id
- DRONE_GITEA_CLIENT_SECRET: your_client_secret

2. ä¿®æ”¹ runner å’Œ drone-server çš„é€šä¿¡å¯†é’¥

- DRONE_RPC_SECRET: your_rpc_secret

```sh
# ç”Ÿæˆä¸€ä¸ªéšæœºé€šä¿¡å¯†é’¥
openssl rand -hex 16
```

3. ä¿®æ”¹å®Œä¹‹åé‡æ–°å¯åŠ¨

```sh
docker compose down
docker compose up -d
```

4. æŸ¥çœ‹ drone-server å’Œ runner æ˜¯å¦é“¾æ¥æˆåŠŸ

```sh
# drone-runner æ˜¯åœ¨ docker-compose.yml ä¸­å®šä¹‰çš„å®¹å™¨å
docker compose logs -f drone-runner

# å¦‚æœå‡ºç°å¦‚ä¸‹å›¾ä¸­æ˜¾ç¤ºçš„å†…å®¹å°±è¯æ˜é“¾æ¥æˆåŠŸäº†
```

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151246340.png)

å¦‚æœç¯å¢ƒæ²¡æœ‰é—®é¢˜, ç™»å½• gite åˆ›å»ºé¡¹ç›®, ç„¶åæäº¤ä»£ç , ç„¶åç™»å½• drone

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151257866.png)

## éƒ¨ç½²é¡¹ç›®åˆ°è‡ªå·±çš„æœåŠ¡å™¨

### å‡†å¤‡æ­¥éª¤

1. è¿˜æ˜¯ä½¿ç”¨ vitepress é¡¹ç›®
2. è¿˜æ˜¯éœ€è¦ä¸€å°å…¬ç½‘èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡å™¨(ä¸¤å°æ›´å¥½: ä¸€å°éƒ¨ç½² gitea + drone, ä¸€å°éƒ¨ç½²é¡¹ç›®)

### åˆ›å»º secrets

1. ç™»å½• drone-server
2. sync åŒæ­¥ä»£ç åº“: å…ˆ `Active` æ¿€æ´», ç„¶åå‹¾é€‰ `Trusted` (å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ç”¨æˆ·ç™»å½•,æ— æ³•çœ‹åˆ°è¿™ä¸ªé€‰é¡¹)
3. åˆ›å»º secrets

å°±æ˜¯ä¸€äº›å˜é‡, ç±»ä¼¼ gitub çš„é‚£ä¸ª Repository secrets

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151259550.png)

### åˆ›å»ºæµæ°´çº¿é…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º: `.drone.yml` å†…å®¹å¦‚ä¸‹

```yml
---
kind: pipeline
type: docker
name: deploy

# push ä»£ç çš„æ—¶å€™å°±è§¦å‘è¿™ä¸ªæµæ°´çº¿
trigger:
  event:
    - push

# å®šä¹‰ç¼“å­˜ç›®å½•(æ”¾åˆ°å®¿ä¸»æœºçš„ /tmp/drone_cache ç›®å½•ä¸‹)
volumes:
  - name: cache
    host:
      path: /tmp/drone_cache

steps:
  # ä½¿ç”¨ç¼“å­˜(å¦‚æœæœ‰çš„è¯)
  - name: restore-cache
    image: drillster/drone-volume-cache
    pull: if-not-exists
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./node_modules

  # å®‰è£…ä¾èµ– ç¼–è¯‘æºç  å‹ç¼©æ‰“åŒ…
  - name: build-and-compress-source-code
    image: node:18
    pull: if-not-exists
    commands:
      - npm install -g pnpm
      - pnpm install --no-frozen-lockfile
      - pnpm docs:build
      - ls -al
      - tar -cjvf dist.bz2 ./run.sh ./docs/.vitepress/dist
      - echo "===== build completed ====="

  # åˆ¶ä½œç¼“å­˜(éœ€è¦æŒ‡å®šç¼“å­˜ç›®å½•, ä¸è¦æ¯æ¬¡å»ä¸‹è½½ node_modules)
  - name: rebuild-cache
    image: drillster/drone-volume-cache
    pull: if-not-exists
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      restore: false
      mount:
        - ./node_modules

  # å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
  - name: upload-file-to-server
    image: appleboy/drone-scp
    pull: if-not-exists
    when:
      branch: main # åªæœ‰åœ¨ push åˆ° main åˆ†æ”¯æ‰æ‰§è¡Œ
    settings:
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_pass
      port:
        from_secret: ssh_port
      command_timeout: 2m
      source: ./dist.bz2
      target: ~/learn-drone-cicd-demo

  # è¿æ¥ä¸ŠæœåŠ¡å™¨ç„¶åæ‰§è¡Œä¸€äº›è„šæœ¬
  - name: deploy-to-server
    image: appleboy/drone-ssh
    pull: if-not-exists
    when:
      branch: main # åªæœ‰åœ¨push åˆ° main åˆ†æ”¯çš„æ—¶å€™æ‰æ‰§è¡Œ
    settings:
      host:
        from_secret: ssh_host
      username:
        from_secret: ssh_user
      password:
        from_secret: ssh_pass
      port:
        from_secret: ssh_port
      command_timeout: 2m
      script:
        - cd ~/learn-drone-cicd-demo
        - tar -xjvf ./dist.bz2
        - pwd
        - ls -al
        - chmod +x ./run.sh && ./run.sh
        - echo "===== deploy completed ====="
```

### åˆ›å»ºéƒ¨ç½²è„šæœ¬

```sh
#!/bin/bash

docker_container_name="learn-drone-cicd-demo"
docker_image_name="nginx:stable"

# å…ˆåœæ­¢åŸæ¥çš„
docker stop $docker_container_name
docker rm $docker_container_name

# å¯åŠ¨å®¹å™¨
docker run -d \
	-p 4000:80 \
	-v $(pwd)/docs/.vitepress/dist:/usr/share/nginx/html \
	--name $docker_container_name $docker_image_name
```

### è¿è¡Œ & æŸ¥çœ‹

æäº¤ä»£ç åˆ° main åˆ†æ”¯å³å¯è§¦å‘

![](https://raw.githubusercontent.com/liaohui5/images/main/images/202312151313501.png)
